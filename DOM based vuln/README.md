> Объектная модель документа (DOM) — это иерархическое представление элементов страницы в веб-браузере. Веб-сайты могут использовать JavaScript для управления узлами и объектами DOM, а также их свойствами. Уязвимости, связанные с DOM, возникают, когда веб-сайт содержит JavaScript, который принимает контролируемое злоумышленником значение, известное как источник, и передаёт его в опасную функцию, известную как приемник.

* Источник и приёмник
  * Источник — это свойство JavaScript, принимающее данные. Примером источника является свойство location.search, поскольку оно считывает входные данные из строки запроса.
  * Приёмник — это потенциально опасная функция JavaScript или объект DOM, которые могут вызвать нежелательные последствия при передаче данных. Например, функция eval() является приёмником, поскольку она обрабатывает переданный ей аргумент как JavaScript.
 
* **Распространенные источники**
```
document.URL
document.documentURI
document.URLUnencoded
document.baseURI
location
document.cookie
document.referrer
window.name
history.pushState
history.replaceState
localStorage
sessionStorage
IndexedDB (mozIndexedDB, webkitIndexedDB, msIndexedDB)
Database
```

* Приемники, которые могут привести к уязвимостям:

|Уязвимость|Приемник|
|--------------------|--------------------|
|DOM XSS|  document.write()|
|Открытое перенаправление  |window.location|
|Манипуляция с файлами cookie|  document.cookie|
|Внедрение JavaScript| eval()|
|Манипуляция с доменом документа| document.domain|
|Отравление URL WebSocket| WebSocket()|
|Манипуляция со ссылкой |element.src|
|Манипуляция с веб-сообщением| postMessage()|
|Манипуляция с заголовком Ajax-запроса| setRequestHeader()|
|Манипуляция с локальным путём к файлу |FileReader.readAsText()|
|Клиентская SQL-инъекция| ExecuteSql()|
|Манипуляция с хранилищем HTML5| sessionStorage.setItem()|
|Внедрение XPath на стороне Клиент |document.evaluate()|
|Внедрение JSON на стороне клиента |JSON.parse()|
|Манипуляция данными DOM |element.setAttribute()|
|Отказ в обслуживании |RegExp()|





# XSS-атака на основе DOM

> Наиболее распространённым источником DOM XSS является URL-адрес, доступ к которому обычно осуществляется с помощью объекта window.location.

* **Методология**
  * *Тестирование HTML-приёмников*
    * Поместить в источник случайную буквенно-цифровую строку (например, location.search),
    * С помощью инструментов разработчика проанализируйте HTML-код и найдите место появления нужной строки. (В инструментах разработчика использовать Control+F для поиска нужной строки в DOM.)
    * Для каждого места определить контекст. (Если строка находится в атрибуте, заключённом в двойные кавычки, добавить двойные кавычки в строку, чтобы проверить, можно ли выйти за пределы атрибута.)
    * Если ваши данные были закодированы в URL до обработки, XSS-атака вряд ли сработает.
  * *Тестирование приёмников выполнения JavaScript*
    * Для каждого потенциального источника, например, location, сначала необходимо найти в JavaScript-коде страницы случаи, когда на него ссылаются. (инструментах разработчика + Control+Shift+F )
    * Использовать отладчик JavaScript, чтобы добавить точку останова и проследить, как используется значение источника.
    * Обнаружив приемник, которому назначаются данные, полученные из источника, использовать отладчик для проверки значения. (наведя курсор на переменную, чтобы увидеть её значение перед отправкой в ​​приемник.)
  * * **Тестирование на DOM XSS с помощью DOM Invader**
   
##  Эксплуатация DOM XSS

* **source location.search -> приёмник document.write**
```
<script>alert(document.domain)</script>
product?productId=1&storeId=London%27><script>alert("XXX")</script>
```
* **Приёмник innerHTML не принимает элементы скрипта**
```
<img src=1 onerror=alert(document.domain)>
```

### **Источники и приемники в сторонних зависимостях**

* **jQuery**
> функция attr() - может изменять атрибуты элементов DOM.
```
$(function() {
$('#backLink').attr("href",(new URLSearchParams(window.location.search)).get('returnUrl'));
});

?returnUrl=javascript:alert(document.domain)
```
> селекторная функция $() - может использоваться для внедрения вредоносных объектов в DOM.
> location.hash - для анимации или автоматической прокрутки к определённому элементу на странице + обработчик событий hashchange
```
$(window).on('hashchange', function() {
var element = $(location.hash);
element[0].scrollIntoView();
});
```
