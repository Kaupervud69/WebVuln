* [Модель безопасности контроля доступа](#Модель-безопасности-контроля-доступа)
  * [Программный контроль доступа
  * [Дискреционный контроль доступа (DAC)
  * [Обязательный контроль доступа (MAC)
  * [Управление доступом на основе ролей (RBAC)
* [Причины возникновения BAC](#Причины-возникновения-BAC)

# **BAC**

> Контроль доступа — это применение ограничений на то, кто или что имеет право выполнять действия или получать доступ к ресурсам.

> Broken Access Control, или просто BAС — это сломанный контроль доступа.

# **Модель безопасности контроля доступа**

* **Программный контроль доступа**:
> При программном контроле доступа матрица привилегий пользователей хранится в базе данных или аналогичной базе данных, а контроль доступа применяется программно со ссылкой на эту матрицу. Этот подход к контролю доступа может включать роли или группы или отдельных пользователей, коллекции или рабочие процессы процессов и может быть очень детализированным.

* **Дискреционный контроль доступа (DAC)**: 
> При дискреционном контроле доступа доступ к ресурсам или функциям ограничивается на основе пользователей или именованных групп пользователей. Владельцы ресурсов или функций имеют возможность назначать или делегировать права доступа пользователям. Эта модель очень детализирована, и права доступа определяются для отдельного ресурса или функции и пользователя. Следовательно, модель может стать очень сложной для проектирования и управления.

* **Обязательный контроль доступа (MAC)**: 
> Обязательный контроль доступа — это централизованно контролируемая система контроля доступа, в которой доступ субъекта к некоторому объекту (файлу или другому ресурсу) ограничен. Важно отметить, что в отличие от DAC пользователи и владельцы ресурсов не имеют возможности делегировать или изменять права доступа к своим ресурсам. Эта модель часто ассоциируется с военными системами, основанными на допуске.

* **Управление доступом на основе ролей (RBAC)**: 
> При управлении доступом на основе ролей определяются именованные роли, которым назначаются привилегии доступа. Затем пользователям назначаются одна или несколько ролей. RBAC обеспечивает улучшенное управление по сравнению с другими моделями контроля доступа и, при правильном проектировании, достаточную детализацию для обеспечения управляемого контроля доступа в сложных приложениях.

# Причины возникновения BAC
  * У разработчиков нет чёткого понимания, какие функции и ресурсы доступны.
  * Разработчики доверяют неявным факторам авторизации — например, реализуют контроль доступа на основе URL-адреса или заголовка Referer.
  * Разработчики забывают добавить функции для проверки контроля доступа, когда работают над новой функциональностью.
  * Контроль доступа реализуется на фронтенде, но не реализуется на бэкенде.
  * Система проверяет права один раз в многошаговом процессе.
    
 # Виды
   * вертикальный — ограничивает доступ на основе роли пользователя в системе,
   * горизонтальный — ограничивает доступ пользователям с одинаковыми привилегиями,
   * контекстно-зависимый — ограничивает доступ в зависимости от состояния приложения.

# Примеры сломанных элементов управления доступом

### Вертикальное повышение привилегий

* **Незащищенная функциональность**

      https://insecure-website.com/admin
      https://insecure-website.com/robots.txt
      Безопасность через неизвестность: https://insecure-website.com/administrator-panel-yb556 (может быть раскрыт в JavaScript)
      Можно использовать список слов для подбора местоположения конфиденциальной функциональности.
__________________________________
* **Методы управления доступом на основе параметров**

Некоторые приложения определяют права доступа или роль пользователя при входе в систему, а затем сохраняют эту информацию в контролируемом пользователем месте.

* Это может быть:

  * Скрытое поле.
  * Файл cookie.
  * Предустановленный параметр строки запроса.

        https://insecure-website.com/login/home.jsp?admin=true
        https://insecure-website.com/login/home.jsp?role=1
        Cookie: Admin=true; session=7CNay1sLaW7cs4bHtTXJVLJ1RDW9DbVY
_________________________________    
* **Нарушенный контроль доступа из-за неправильной настройки платформы**

> Некоторые фреймворки приложений поддерживают различные нестандартные заголовки HTTP, которые можно использовать для переопределения URL.


|Nginx,Apache,Traefik|X-Original-URL|
|:-------------:|:-------------:|
|Прокси,API-шлюзы|X-Rewrite-URL|
|Кастомные Прокси|X-Forwarded-Path|
|Веб-серверы|X-Request-URI|
||X-Original-URL|

|Nginx,Apache||
|:-----------:|:-------------:|
|Подмена пути|X-Rewritten-URL|
|Возможный SSRF|X-Accel-Redirect|
|Возможный SSRF|X-Sendfile|

|Cloudflare||
|:-------------:|:--------------:|
|Если CDN доверяет заголовку|CF-Original-URL|
|Обход IP фильтров|True-Client-IP|

|Node.js||
|:-------------:|:--------------:|
||X-Original-Path|
|Подмена пути API|X-Forwarded-Uri|

|PHP||
|:-------------:|:--------------:|
||X-Original-Path-info|
|WordPress|X-Rewrite-Original|

* Тестирование
```
Доступ к /admin заблокирован
Если ответ очень простой, это предполагает, что он может быть получен от внешней системы.
Добавить HTTP-заголовок X-Original-URL: /invalid
Получить подтверждение что заголовок обрабатывается
```
> Альтернативная атака связана с методом HTTP, используемым в запросе. Ипользуя метод GET (или другой) для выполнения действий по ограниченному URL, можно обойти контроль доступа, реализованный на уровне платформы. 
______________________________________________
* **Неработающий контроль доступа из-за несоответствий в сопоставлении URL-адресов**

Веб-сайты могут различаться по степени строгости соответствия пути входящего запроса определенной конечной точке.

```
/ADMIN/DELETEUSER = /admin/deleteUser
/admin/deleteUser.anything = /admin/deleteUser
/admin/deleteUser = /admin/deleteUser/
```
_____________________________________________
# **Профит**
  
   * нарушение работы веб-приложения;
   * изменение паролей пользователей;
   * удаление пользователей;
   * публикация вредоносного или провокационного контента;
   * использование любых функций, доступных через админ-панель.
   * получить доступ к чужому личному кабинету;
   * перевести деньги с чужого аккаунта;
   * просматривать чужие чаты или сообщения;
   * получить доступ к личной и чувствительной информации пользователя (да-да, все узнают, что ты делал прошлым летом);
   * изменить пароль, телефон, email или другие данные другого пользователя — это позволяет полностью перехватить управление аккаунтом;
   * разместить пост с вредоносным кодом, ссылкой на фишинговый сайт или оскорблениями через аккаунт другого пользователя.

# **Защита**

   * Никогда не полагайся только на случайные числовые id для контроля доступа к объекту. Хакер может их забрутфорсить.
   * Следуй принципу наименьших привилегий: запрещай всё по умолчанию. Потом выдавай доступ тем, кому он действительно нужен.
   * По возможности используй единый механизм контроля доступа на уровне всего приложения.
   * Тщательно проверяй и тестируй средства управления доступом перед релизом. Так ты поймёшь, работают они или нет.
   * Реализуй средства управления доступом и на клиентской части приложения, и на серверной.
   * После разработки новой функциональности в приложении не будет лишним проверить его от лица пользователей с разным уровнем привилегий. Так ты убедишься, что каждый из них имеет доступ только к разрешенным ресурсам.
