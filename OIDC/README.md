> OpenID Connect - расширяет протокол OAuth и добавляет уровень идентификации и аутентификации. 

OpenID Connect аккуратно встраивается в обычные потоки OAuth. С точки зрения клиентского приложения, ключевым отличием является то, что существует дополнительный стандартизированный набор областей, которые одинаковы для всех провайдеров, и дополнительный тип ответа: id_token.

**Роли OpenID Connect**
* `Проверяющая сторона` — приложение, которое запрашивает аутентификацию пользователя. Это синоним клиентского приложения OAuth.
* `Конечный пользователь` — пользователь, который проходит аутентификацию. Это синоним владельца ресурса OAuth.
* `Поставщик OpenID` — служба OAuth, настроенная для поддержки OpenID Connect.

**Утверждения и области действия OpenID Connect**

> «утверждения» - параы ключ:значение, которые представляют информацию о пользователе на сервере ресурсов. Одним из примеров утверждения может быть «family_name»: «Flugegehaymen».

Все службы OpenID Connect используют идентичный набор областей действия.

* openid:
```
profile
  family_name, given_name, birth_date
email
address
phone
```
**Идентификационный токен**

> тип ответа id_token - возвращает веб-токен JSON (JWT), подписанный веб-подписью JSON (JWS). Полезная нагрузка JWT содержит список утверждений на основе изначально запрошенной области действия. Содержит информацию о том, как и когда пользователь в последний раз был аутентифицирован службой OAuth. Cокращает количество запросов, которые необходимо отправлять между клиентским приложением и службой OAuth

Клиентское приложение может использовать это, чтобы решить, был ли пользователь достаточно аутентифицирован.

> криптографические ключи для проверки подписи передаются по тому же сетевому каналу (обычно представленному в ```/.well-known/jwks.json```)

* OAuth поддерживает несколько типов ответов, поэтому клиентское приложение может отправлять запрос на авторизацию как с базовым типом ответа OAuth, так и с типом ответа id_token OpenID Connect:
```
response_type=id_token token
response_type=id_token code
```

# Идентификация OpenID Connect

* Самый надежный способ проверки — поиск обязательной области действия OpenID.
* Документация поставщика OAuth, чтобы узнать, есть ли какая-либо полезная информация о поддержке OpenID Connect
* Получить доступ к файлу конфигурации из стандартной конечной точки /.well-known/openid-configuration
  
> если изначально процесс входа не использует OpenID Connect, попробовать добавить область действия OpenID или изменить тип ответа на id_token и посмотреть, приведет ли это к ошибке.

# Уязвимости OpenID Connect

## Незащищенная динамическая регистрация клиента

Спецификация OpenID описывает стандартизированный способ, позволяющий клиентским приложениям регистрироваться у поставщика OpenID.

```python
POST /openid/register HTTP/1.1
Content-Type: application/json
Accept: application/json
Host: oauth-authorization-server.com
Authorization: Bearer ab12cd34ef56gh89

{
"application_type": "web",
"redirect_uris": [
"https://client-app.com/callback",
"https://client-app.com/callback2"
],
"client_name": "My Application",
"logo_uri": "https://client-app.com/logo.png",
"token_endpoint_auth_method": "client_secret_basic",
"jwks_uri": "https://client-app.com/my_public_keys.jwks",
"userinfo_encrypted_response_alg": "RSA1_5",
"userinfo_encrypted_response_enc": "A128CBC-HS256",
…
}
```
Некоторые из этих свойств могут быть предоставлены как URI. Если поставщик OpenID получает доступ к любому из них, это может потенциально привести к уязвимостям SSRF второго порядка, если не будут приняты дополнительные меры безопасности.

> Поставщик OpenID должен требовать от клиентского приложения пройти аутентификацию. В приведенном выше примере они используют HTTP bearer token.

## Разрешение запросов авторизации по ссылке

Некоторые поставщики OpenID предоставляют возможность передавать их как веб-токен JSON (JWT). Если эта функция поддерживается, можно отправить один параметр request_uri, указывающий на веб-токен JSON, содержащий остальные параметры OAuth и их значения.

> Можно использовать эту функцию для обхода проверки этих значений параметров. Некоторые серверы могут эффективно проверять строку запроса в запросе авторизации, но могут не применять адекватно ту же проверку к параметрам в JWT, включая redirect_uri.

**Чтобы проверить**:
Найди опцию request_uri_parameter_supported в файле конфигурации и документации или попробуй добавить параметр request_uri, чтобы посмотреть, работает ли он.

Некоторые серверы поддерживают эту функцию, даже если они явно не упоминают ее в своей документации.




