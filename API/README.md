* [Сбор информации](#Сбор-информации)
  	*
  	*
	*
* [Основные уязвимости API](#Основные-уязвимости-API)
  	* [BOLA](#BOLA--Broken-Object-Level-Authorization)
	* [BA](#BA--Broken-Authentication) 
	* [URC](#URC--Unrestricted-Resource-Consumption) 
	* [BFLA](#BFLA--Broken-Function-Level-Authorization) 
	* [UASBF](#UASBF--Unrestricted-Access-to-Sensitive-Business-Flows)
	* [SSRF](#SSRF--Server-Side-Request-Forgery) 
	* [IIM](#IIM--Improper-Inventory-Management)
	* [UCA](#UCA--Unsafe-Consumption-of-API)

* 

# API тестирование

> API (интерфейсы прикладного программирования) позволяют программным системам и приложениям взаимодействовать и обмениваться данными. (Дополнительная поверхность атаки.)



# Сбор информации

* Проанализтровать документацию:
	* /api
	* /swagger/index.html
	* /openapi.json
	* /wp-json/wp/v2/
* Если вы идентифицируете конечную точку для ресурса, обязательно изучите базовый путь.
	* /api/swagger/v1
	* /api/swagger
	* /api
* Проверить методы на точках.
	* GET/POST/DELETE/OPTIONS/PATCH - применяет частичные изменения к ресурсу.
* Определение поддерживаемых типов контента
	* Измените заголовок Content-Type, а затем соответствующим образом переформатируйте тело запроса.
	* Вызывать ошибки, раскрывающие полезную информацию.
	* Обходить несовершенные средства защиты.
	* Использовать преимущества различий в логике обработки. Например, API может быть безопасным при обработке данных JSON, но уязвимым для атак с внедрением при работе с XML.

* **Точки входа**
Поиск скрытых параметров
*	Уязвимости массового назначения
Массовое назначение (также известное как автоматическое связывание) может непреднамеренно создавать скрытые параметры. Это происходит, когда программные фреймворки автоматически привязывают параметры запроса к полям внутреннего объекта. Массовое назначение может привести к тому, что приложение будет поддерживать параметры, которые разработчик никогда не планировал обрабатывать.

PATCH /api/users/
"username": "wiener",
"email": "wiener@example.com",
}
Параллельный запрос GET /api/users/123 возвращает следующий JSON:
{
"id": 123,
"name": "John Doe",
"email": "john@example.com",
"isAdmin": "false"
}





# Основные уязвимости API

> BOLA
>> Broken Object Level Authorization, возникает, когда мы можем обратиться к объектам, к которым у нас не должно быть доступа (например, к информации о чужом заказе или к чужим сообщениям).
>
> BA
>> Broken Authentication, возникает, когда сервер не проверяет или недостаточно проверяет аутентификацию на доступ к запросам. Например, сервер считает внутренние запросы по умолчанию доверенными и аутентифицированными без каких-либо токенов.
>
> URC
>> Unrestricted Resource Consumption, возникает, когда злоумышленник может исчерпать ресурсы сервера или компании, отправив множество запросов на создание файлов, отправку СМС или получение отчётов.
>
> BFLA
>> Broken Function Level Authorization, очень похожа на BOLA, но здесь мы обращаемся к функции без должного уровня прав.
>
> UASBF
>> Unrestricted Access to Sensitive Business Flows, возникает при обходе или нарушении изначального порядка запросов в бизнес-логике приложения.
>
> SSRF
>> Server-Side Request Forgery, возникает, когда у нас есть возможность отправлять запросы от имени сервера как во внутреннюю сеть, так и во внешнюю.
>
> IIM
>> Improper Inventory Management, возникает, когда разработчики не следят за уязвимыми версиями API или оставляют тестовые API в открытом доступе.
>
> UCA
>> Unsafe Consumption of API, возникает, когда разработчики слепо доверяют API третьих лиц, не проверяют и не санитизируют данные, приходящие от таких API.

## **BOLA — Broken Object Level Authorization**

*Нарушение авторизации на уровне объекта.* Возникает когда пользователь может получить доступ к объектам или данным, к которым у него не должно быть доступа.

### **Основная характеристика:**

* **Как часто встречается:** часто.  
* **Насколько сложно обнаружить:** обнаружить легко.  
* **Насколько сложно эксплуатировать:** эксплуатировать легко.  
* **Импакт**: зависит от бизнес-логики приложения. Может привести к раскрытию чувствительных данных и манипулированию ими. В худшем случае — приводит к полному захвату аккаунта.

### **Как обнаружить:**

1. Выполни действие со своим объектом. Попробуй прочитать его, отредактировать и удалить.  
2. Попробуй выполнить эти действия с объектом другого пользователя. Для этого поменяй ID объекта в своём запросе.  
3. Если запрос выполнится успешно, приложение уязвимо.

### **Как защищаться:**

* **Использовать надёжные механизмы авторизации.** Нужно создать политики авторизации, которые будет легко контролировать. И обязательно тестировать их — тщательно и регулярно. Только так можно убедиться, что в них нет логических ошибок или лазеек.  
* **Внедрить авторизацию на каждый запрос к API**. Каждый пользователь должен проходить авторизацию, когда запрашивает конфиденциальные данные. Аутентификации тут недостаточно.  
* **Использовать UUID**. Предложи разработчикам переосмыслить то, как они создают идентификаторы объектов в API и управляют ими. Лучше всего использовать случайные идентификаторы. Например, UUID. У таких значений высокая энтропия: их практически невозможно угадать или забрутфорсить. Но стоит отметить, что это мера митигации, а не полноценная защита.

## **BA — Broken Authentication**

*Нарушение аутентификации.* Приложению не удаётся должным образом аутентифицировать пользователей. Это приводит к недостаточной защите конфиденциальной информации и ресурсов.

### **Основная характеристика:**

* **Как часто встречается:** часто..  
* **Насколько сложно обнаружить:** обнаружить легко.  
* **Насколько сложно эксплуатировать:** эксплуатировать средне-легко.  
* **Импакт**: перехват учётных записей, подделка сессий и транзакций, доступ к административной панели. 

### **Как обнаружить:**

1. Проверить длину и сложность пароля. Если пароль слабый, то возникает угроза брутфорса.  
2. Проверить рейт-лимиты. Чрезмерно высоĸие или отсутствующие рейт-лимиты. Это тоже увеличивает рисĸ успешного брутфорса.  
3. Проверь временной интервал, в течение ĸоторого пароли, сертифиĸаты или тоĸены действительны.  
4. Проверить как передаются аутентифиĸационные данные, их не должно быть в URL-адресе.  
5. Проверить сценарий смены чувствительных данных — пароля, почты, телефона. Система должна запрашивать пароль, одноразовый пароль или СМС-ĸод.  
6. Система должна проверять тоĸены и не принимать неподписанные или слабо подписанные тоĸены JWT.  
7. Убедись, что дата истечения сроĸа действия JWT проверяется ĸорреĸтно. Сервер не должен принимать JWT-тоĸены, у ĸоторых истёĸ сроĸ действия.  
8. Убедись, что не используются простые теĸстовые, незашифрованные или слабо хешированные пароли, слабые ĸлючи шифрования (MD5, SHA-1).

### **Как защищаться:**

* **Используйте проверенные библиотеĸи и стандарты.** Не придумывайте решения в области аутентифиĸации, генерации тоĸенов или хранения паролей.  
* **Настройте рейт-лимиты или аĸтивируйте ĸапчи** для всех ĸонечных точеĸ ввода логина, пароля, тоĸена и одноразовых ĸодов.  
* **При смене чувствительных данных, таĸих ĸаĸ почта, пароль, номер телефона, требуйте подтверждающий фаĸтор.** Например, теĸущий пароль, ĸод с почты или телефона.  
* **Внедрите многофаĸторную аутентифиĸацию.**  
* **Не используйте ĸлючи API для аутентифиĸации пользователей.** Их следует использовать тольĸо для аутентифиĸации ĸлиентов API.

## **URC — Unrestricted Resource Consumption**

*Неограниченное потребление ресурсов.* Злоумышленник отправляет так много запросов к серверу веб\-приложения, что ресурсы исчерпываются. В худшем случае приложение перестаёт работать.

### **Основная характеристика:**

* **Как часто встречается:** часто.  
* **Насколько сложно обнаружить:** обнаружить легко.  
* **Насколько сложно эксплуатировать:** эксплуатировать легко.  
* **Импакт**: приводит к отказу в обслуживании (DoS) и увеличению операционных затрат из\-за исчерпания ресурсов.

### **Как обнаружить:**

1. Посмотреть наличие ограничений работы СМС-сервера, если их нет, то высок риск URC.  
2. Проверить GraphQL и загрузчик файлов на возможность загрузки большого объёма или количества файлов.  
3. Проверить ограничения на исполнение «тяжёлых» задач. 

### **Как защищаться:**

* **Ограничьте использование ресурсов** — оперативной памяти, центрального процессора, дискового пространства, файловых дескрипторов и процессов.   
* **Внедрите проверку входных данных**. Определите и обеспечьте соблюдение ограничений максимального размера для входных параметров и полезных данных: длины строк, количества элементов в массивах и максимального размера загружаемого файла.  
* **Ограничьте скорость.** Внедрите механизмы ограничения скорости — рейт-лимиты. Так вы сможете контролировать частоту взаимодействия клиента с API в течение периода времени. Рейт-лимиты подбираются исходя из потребностей приложения.  
* **Ограничьте выполнение одной операции** — количество раз или частоту, с которой пользователь API выполняет операцию.   
* **Реализуйте комплексную проверку на стороне сервера** для параметров строки запроса и тела запроса. Проверяйте параметры, контролирующие количество записей, возвращаемых в ответе API.  
* **Настройте лимиты и оповещения** — установите лимиты расходов для поставщиков услуг API.

## **BFLA — Broken Function Level Authorization**

*Нарушение авторизации на уровне функций.* Приложениям не удаётся ограничить использование конфиденциальных функций кругом авторизованных пользователей.

### **Основная характеристика:**

* **Как часто встречается:** часто.  
* **Насколько сложно обнаружить:** обнаружить средне-легко.  
* **Насколько сложно эксплуатировать:** эксплуатировать легко.  
* **Импакт**: злоумышленник получает доступ к функциям администратора и данным пользователей. Это может нарушить конфиденциальность и работу приложения.

### **Как обнаружить:**

BFLA схож с BOLA — сломанную авторизацию на уровне объекта. Различие состоит в том, что BFLA нацелена на функцию API, а BOLA — на объекты, с которыми API взаимодействует. Поэтому принципы обнаружения здесь такие же.

### **Как защищаться:**

* **Реализуйте детальный и строгий контроль доступа** на основе пользовательского сеанса. Доступ должен осуществляться последовательно — независимо от метода запроса, заголовка и параметров URL.  
* **Примените принцип наименьших привилегий** — по умолчанию любой доступ должен быть запрещён.  
* **Разрешайте операции не отдельным пользователям, а пользователям определённых ролей или групп**.

## **UASBF — Unrestricted Access to Sensitive Business Flows**

*Неограниченный доступ к чувствительным бизнес-потокам.* В данном контексте бизнес-поток — последовательность действий компании, которая приводит к заработку денег.

### **Основная характеристика:**

* **Как часто встречается:** зависит от устройства бизнес-логики приложения, чем больше и сложнее приложение, тем большая вероятность уязвимости.  
* **Насколько сложно обнаружить:** сложно, невозможно обнаружить сканерами, требуется ручная проверка потоков.  
* **Насколько сложно эксплуатировать:** эксплуатировать легко.  
* **Импакт**: успешная атака может привести к краже товаров из интернет-магазина, базы данных телефонных номеров, бронирования мест без подтверждения или репутационных рисков для взломанной компании.

### **Как обнаружить:**

URC специфическая уязвимость, она возникает не из\-за какой-то технической проблемы, а из\-за проблем с логикой. Поэтому стоит сначала изучить бизнес компании, для которой ты проводишь пентест. Какие используются API и почему именно они. Как пользователь взаимодействует с веб\-приложением. Какие есть эндпоинты и насколько хорошо они защищены от зловредного воздействия. 

### **Как защищаться:**

Однозначных рекомендаций по устранению данного типа уязвимостей для всех типов сервисов нет, но всегда можно внедрить дополнительные заградительные барьеры:

* **Капча.** Реальные пользователи не любят капчу, потому что она мешает доступу. Зато неплохо осаживает ботов и хакеров.  
* **Проверка банковской карты.** Необходимо внедрить софт, который будет проверять подлинность банковской карты и наличие достаточных средств на счёте клиента для проведения операции.  
* **Предоплата.** Очень эффективная штука для бизнеса в сфере услуг.  
* **Лимиты операций.** Для критичных эндпоинтов стоит внедрить логический лимит операций для одного пользователя. Например, на маркетплейсах есть лимит на количество штук одного товара для заказа.

## **SSRF — Server-Side Request Forgery**

*Подделка запроса со стороны сервера.* Позволяет злоумышленнику отправлять запросы от имени сервера на внутренние ресурсы или внешние системы, что может привести к различным видам атак, включая обход брандмауэра, доступ к внутренним системам и сервисам, чтение конфиденциальной информации и т. д.

### **Основная характеристика:**

* **Как часто встречается:** средняя распространённость.  
* **Насколько сложно обнаружить:** средне-сложно, нужно найти подходящий API запрос.  
* **Насколько сложно эксплуатировать:** эксплуатировать легко.  
* **Импакт**: успешная эксплуатация открывает доступ к внутренним службам и возможности сканировать внутреннюю сеть и порты. Также хакер может использовать взломанный сервер как прокси для атак на другие системы.

### **Как обнаружить:**

Чтобы обнаружить SSRF нужно проверить основные векторы атаки, которые используют злоумышленники: 

* **HTTP- и HTTPS-запросы.** Хакер использует SSRF для выполнения HTTP- и HTTPS-запросов с сервера на внутренние или внешние системы.  
* **Обращение к внутренним ресурсам.** Атакующий может обращаться к внутренним ресурсам, к которым обычно нет доступа извне.  
* **Компрометация данных и служб.** SSRF неплохо подходит для кражи конфиденциальной информации или даже для атаки на внутренние службы.  
* **Локальные и удалённые адреса.** Злоумышленник отправляет запрос на локальные IP-адреса или адреса внутренних систем, обходя стандартные проверки доступа.  
* **Протоколы маршрутизаторов.** Для атаки также подходят специальные протоколы, такие как `file://`, `dict://`, `gopher://`, — для выполнения нежелательных действий.

### **Как защищаться:**

* **Фильтрация входных данных.** Проверяй и фильтруй вводимые URL-адреса и ограничивай доступ только к необходимым ресурсам.  
* **Использование белых списков.** Давай доступ только к известным и доверенным ресурсам, используя белые списки.  
* **Изоляция серверов.** Изолируй серверы от внутренних систем и используй прокси или firewalls для контроля доступа.

## **IIM — Improper Inventory Management**

*Неправильное управление запасами.* Здесь под запасами подразумеваются старые версии используемых API, которые могут накапливаться в коде веб\-приложения.

### **Основная характеристика:**

* **Как часто встречается:** широкая распространённость.  
* **Насколько сложно обнаружить:** средне-сложно, устаревшие версии API сложно найти, так как их документация либо нет, либо она спрятана. Можно использовать фаззинг, просмотреть публичные репозитории на GitHub, найти старые конфигурации или поддомены.  
* **Насколько сложно эксплуатировать:** эксплуатировать легко.  
* **Импакт**: злоумышленник может получить доступ к конфиденциальной информации или даже захватить сервер. Всё зависит от конкретных уязвимостей в устаревших версиях API.

### **Как обнаружить:**

* **Проверка директорий и поддоменов.** Проанализируй URL-структуру приложения или сайта, чтобы идентифицировать потенциально интересные директории и поддомены.  
* **Аутентификация и авторизация.** Проверь, есть ли необходимая проверка подлинности и авторизация при доступе к API. Также стоит проверить настройку ролей и разрешений на доступ к ресурсам.  
* **Компрометация данных и служб.** SSRF неплохо подходит для кражи конфиденциальной информации или даже для атаки на внутренние службы.  
* **Локальные и удалённые адреса.** Злоумышленник отправляет запрос на локальные IP-адреса или адреса внутренних систем, обходя стандартные проверки доступа.  
* **Протоколы маршрутизаторов.** Для атаки также подходят специальные протоколы, такие как `file://`, `dict://`, `gopher://`, — для выполнения нежелательных действий.

### **Как защищаться:**

* **Вести инвентаризацию** доступных методов API — пользователю должны быть доступны только актуальные методы.  
* **Разграничивать продуктивные и тестовые среды.** Тестовые среды не рекомендуется делать доступными в сети без аутентификации.  
* **Проводить ревью исходных кодов**, не допускать попадания конфиденциальной информации в исходные коды, которые будут доступны конечному пользователю.  
* **Проводить регулярный аудит безопасности** и своевременно обновлять версии API или менять их при появлении публичного эксплоита.

## **UCA — Unsafe Consumption of API**

Разработчик может слишком доверять данным сторонних API, так как считает их доверенными. Из-за недостаточной проверки данных и возникает Unsafe Consumption of API — **небезопасное использование API**. При обнаружении хакером уязвимостей в дружественном API небезопасными становятся все взаимодействующие с ним API.

### **Основная характеристика:**

* **Как часто встречается:** средняя распространённость.  
* **Насколько сложно обнаружить:** сложно, даже в случае успешной атаки найти сторонний API, который стал причиной, не всегда просто.  
* **Насколько сложно эксплуатировать:** эксплуатировать легко.  
* **Импакт**: варьируется от того, что целевой API делает с данными. Успешная эксплуатация может привести к утечке конфиденциальной информации..

### **Как обнаружить:**

* **Проверь аутентификацию и авторизацию.** Это уже как мантра успешного пентеста. Убедись, что API требует аутентификации для доступа к его функциональности. Проверь надёжность методов аутентификации, права доступов и роли пользователей.  
* **Проверь фильтрацию и валидацию входных данных.** Убедись, что входные данные, получаемые из API, проверяются и фильтруются на предмет вредоносного содержимого. Используй методы проверки, такие как валидация форматов данных, защита от инъекций кода (SQL-инъекций или XSS-атак), а также проверка размера и типа данных, чтобы не допустить переполнение буфера или другие виды атак.  
* **Проверь возможные уязвимости, связанные с раскрытием информации.** Убедись, что API не раскрывает конфиденциальную информацию, такую как персональные данные пользователей, в ответах или сообщениях об ошибках. Проверь, что API не передаёт данные о конфигурации системы, включая информацию о базах данных или версиях используемых программных компонентов.

### **Как защищаться:**

* **Оценку безопасности API-провайдеров.** При интеграции сторонних API стоит отдавать предпочтение компаниям с хорошей репутацией в отношении безопасности продуктов. Но помни, что это решение не панацея, любая сложная система потенциально уязвима.  
* **Защищённое соединение для обмена данными.** Убедись, что все взаимодействия с API происходят через защищённый канал связи (TLS).  
* **Валидацию и санитизацию.** Не забывай очищать и обезвреживать данные, полученные от API, на этапе приёмке.  
* **Создание белого списка.** Следует создать и поддерживать белый список известных мест, куда могут перенаправляться API. Не стоит использовать слепой редирект.


# Защита
Защитите свою документацию, если вы не планируете, чтобы ваш API был общедоступным.
Убедитесь, что ваша документация актуальна, чтобы законные тестировщики имели полную видимость поверхности атаки API.
Примените разрешенный список разрешенных методов HTTP.
Убедитесь, что тип содержимого ожидаем для каждого запроса или ответа.
Используйте общие сообщения об ошибках, чтобы не раскрывать информацию, которая может быть полезна злоумышленнику.
Используйте защитные меры во всех версиях вашего API, а не только в текущей рабочей версии.

Чтобы предотвратить уязвимости массового назначения, добавьте в список разрешенных свойств, которые может обновлять пользователь, и заблокируйте конфиденциальные свойства, которые не должны обновляться пользователем.	

